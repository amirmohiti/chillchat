# =========================
# ChillChat Bot (CBot.py)
# Clean & Improved Version
# =========================
# Structure: Webhook + FastAPI
# Features: Registration Flow, Admin Approval, Feedback System
# Author: Based on original BigshotCrymax/Cbot
# Rewritten with bugfixes and cleanup by ChatGPT
# =========================

import os
import json
import asyncio
import logging
from datetime import datetime, timedelta

from fastapi import FastAPI, Request
from telegram import (
    InlineKeyboardButton, InlineKeyboardMarkup,
    Update, User, Message
)
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    ContextTypes, MessageHandler, filters
)
from telegram.constants import ParseMode

# Logging setup
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ======================
# Environment Variables
# ======================

BOT_TOKEN = os.getenv("BOT_TOKEN")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID", "0"))
DATA_CENTER_CHAT_ID = int(os.getenv("DATA_CENTER_CHAT_ID", "0"))

MALE_LIMIT_PER_EVENT = int(os.getenv("MALE_LIMIT_PER_EVENT", "10"))
EVENT_CAPACITY = int(os.getenv("EVENT_CAPACITY", "25"))
AUTO_APPROVE_HOURS = int(os.getenv("AUTO_APPROVE_HOURS", "12"))
SHOW_JSON_IN_PINNED = os.getenv("SHOW_JSON_IN_PINNED", "0") == "1"

CHANNEL_LINK = os.getenv("CHANNEL_LINK", "https://t.me/chillchatcommunity")
GROUP_LINK = os.getenv("GROUP_LINK", "https://t.me/chillchatgroup")
INSTAGRAM_LINK = os.getenv("INSTAGRAM_LINK", "https://instagram.com/chillchat.iran")

# Admin Username (used in CAFE_INTRO)
CAFE_INTRO_USERNAME = os.getenv("CAFE_INTRO_USERNAME", "ifyoulostme")

# Events JSON
EVENTS_JSON = os.getenv("EVENTS_JSON", "[]")
try:
    EVENTS = json.loads(EVENTS_JSON)
except json.JSONDecodeError:
    EVENTS = []

# ======================
# In-Memory Data Storage
# ======================

PENDING = {}  # pending registrations
ROSTER = {}   # approved participants

# Each dict follows:
# PENDING[event_id][user_id] = {...user data...}
# ROSTER[event_id][user_id] = {...user data...}

# ======================
# Text Constants
# ======================

WELCOME_TEXT = (
    "ğŸ‘‹ Ø¨Ù‡ ChillChat Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!\n\n"
    "Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¯ÙˆØ±Ù‡Ù…ÛŒâ€ŒÙ‡Ø§ÛŒ ØªÙ…Ø±ÛŒÙ† Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ú¯Ø²Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… â˜•ï¸âœ¨\n"
    "Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø¹Ø¯ÛŒØŒ ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ Ú¯Ø²ÛŒÙ†Ù‡ Ø²ÛŒØ± Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ ğŸ‘‡"
)

MAIN_MENU = InlineKeyboardMarkup([
    [InlineKeyboardButton("ğŸ“… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯", callback_data="register")],
    [InlineKeyboardButton("ğŸ’¬ Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø± ÛŒØ§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯", callback_data="feedback")],
    [InlineKeyboardButton("ğŸ“ Ù…Ø¹Ø±ÙÛŒ Ú©Ø§ÙÙ‡", callback_data="cafe_intro")],
    [
        InlineKeyboardButton("ğŸ“¢ Ú©Ø§Ù†Ø§Ù„", url=CHANNEL_LINK),
        InlineKeyboardButton("ğŸ‘¥ Ú¯Ø±ÙˆÙ‡", url=GROUP_LINK)
    ],
    [InlineKeyboardButton("ğŸ“¸ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…", url=INSTAGRAM_LINK)],
])

# ======================
# Feedback Storage Flag
# ======================

# user_data["awaiting_feedback"] will be used to detect if the next message is feedback

# ======================
# Ø¨Ø®Ø´ Ø¯ÙˆÙ…: Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ ØªØ£ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ†
# ======================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø´Ø±ÙˆØ¹ Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±"""
    await update.message.reply_text(WELCOME_TEXT, reply_markup=MAIN_MENU)


# ========== Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„: Ø´Ø±ÙˆØ¹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ==========
async def handle_register_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    # Ù„ÛŒØ³Øª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø§Ø² ENV
    if not EVENTS:
        await query.edit_message_text("ÙØ¹Ù„Ø§Ù‹ Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ ğŸš«")
        return

    keyboard = [
        [InlineKeyboardButton(event["name"], callback_data=f"event_{event['id']}")]
        for event in EVENTS
    ]
    await query.edit_message_text("ÛŒÚ©ÛŒ Ø§Ø² Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ğŸ‘‡", reply_markup=InlineKeyboardMarkup(keyboard))


# ========== Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…: Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ==========
async def handle_event_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    event_id = query.data.split("_")[1]
    context.user_data["event_id"] = event_id

    await query.edit_message_text(
        "ğŸ‘¤ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒâ€ŒØª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³:"
    )
    context.user_data["register_step"] = "name"


async def handle_registration_steps(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø§Ø­Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±"""
    user = update.effective_user
    text = update.message.text
    step = context.user_data.get("register_step")

    if not step:
        return

    # Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù…
    if step == "name":
        context.user_data["name"] = text
        context.user_data["register_step"] = "gender"
        await update.message.reply_text("ğŸ‘« Ø¬Ù†Ø³ÛŒØªØª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø±Ø¯ / Ø²Ù†):")
        return

    # Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù†Ø³ÛŒØª
    if step == "gender":
        context.user_data["gender"] = text.lower()
        context.user_data["register_step"] = "age"
        await update.message.reply_text("ğŸ‚ Ø³Ù†Øª Ú†Ù‚Ø¯Ø±Ù‡ØŸ")
        return

    # Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø³Ù†
    if step == "age":
        context.user_data["age"] = text
        context.user_data["register_step"] = "level"
        await update.message.reply_text("ğŸ“š Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†Øª Ú†Ù‚Ø¯Ø±Ù‡ØŸ (Ù…Ø«Ù„Ø§Ù‹: Intermediate)")
        return

    # Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†
    if step == "level":
        context.user_data["level"] = text
        context.user_data["register_step"] = "phone"
        await update.message.reply_text("ğŸ“ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (ÛŒØ§ Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…) Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³:")
        return

    # Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡
    if step == "phone":
        context.user_data["phone"] = text
        context.user_data["register_step"] = "note"
        await update.message.reply_text("ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ÛŒØ§ ØªÙˆØ¶ÛŒØ­ Ø§Ø¶Ø§ÙÙ‡â€ŒØ§ÛŒ Ø¯Ø§Ø±ÛŒØŸ (Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¯Ø§Ø´ØªÙ†ØŒ Ø¨Ù†ÙˆÛŒØ³: - )")
        return

    # Ù…Ø±Ø­Ù„Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    if step == "note":
        context.user_data["note"] = text
        event_id = context.user_data["event_id"]

        # Ø³Ø§Ø®Øª Ø¯ÛŒØªØ§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        user_data = {
            "id": user.id,
            "name": context.user_data["name"],
            "gender": context.user_data["gender"],
            "age": context.user_data["age"],
            "level": context.user_data["level"],
            "phone": context.user_data["phone"],
            "note": context.user_data["note"],
            "timestamp": datetime.now().isoformat()
        }

        if event_id not in PENDING:
            PENDING[event_id] = {}
        PENDING[event_id][user.id] = user_data

        await send_to_admin(context, event_id, user_data)
        await update.message.reply_text("Ø¯Ø±Ø®ÙˆØ§Ø³ØªØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ… Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´ ğŸ™Œ")

        context.user_data.clear()


# ========== Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† ==========
async def send_to_admin(context, event_id, user_data):
    """Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø¯ÛŒØªØ§Ø³Ù†ØªØ± Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯"""
    text = (
        f"ğŸ†• <b>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</b>\n"
        f"ğŸ‘¤ {user_data['name']}\n"
        f"âš§ {user_data['gender']}\n"
        f"ğŸ‚ {user_data['age']}\n"
        f"ğŸ“š {user_data['level']}\n"
        f"ğŸ“ {user_data['phone']}\n"
        f"ğŸ“ {user_data['note']}\n\n"
        f"<b>Ø±ÙˆÛŒØ¯Ø§Ø¯:</b> {get_event_name(event_id)}"
    )

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("âœ… ØªØ£ÛŒÛŒØ¯", callback_data=f"approve_{event_id}_{user_data['id']}"),
            InlineKeyboardButton("âŒ Ø±Ø¯", callback_data=f"reject_{event_id}_{user_data['id']}")
        ]
    ])

    await context.bot.send_message(
        chat_id=DATA_CENTER_CHAT_ID,
        text=text,
        reply_markup=keyboard,
        parse_mode=ParseMode.HTML
    )


# ========== ØªØ£ÛŒÛŒØ¯ Ùˆ Ø±Ø¯ ==========
async def handle_admin_decision(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data.split("_")
    action, event_id, user_id = data[0], data[1], int(data[2])

    if event_id not in PENDING or user_id not in PENDING[event_id]:
        await query.edit_message_text("â›”ï¸ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯ÛŒÚ¯Ù‡ Ø¯Ø± ØµÙ Ù†ÛŒØ³Øª.")
        return

    user_data = PENDING[event_id].pop(user_id)

    if action == "approve":
        if check_capacity_limit(event_id, user_data):
            if event_id not in ROSTER:
                ROSTER[event_id] = {}
            ROSTER[event_id][user_id] = user_data
            await query.edit_message_text(f"âœ… {user_data['name']} ØªØ£ÛŒÛŒØ¯ Ø´Ø¯.")
            await notify_user(context, user_id, True, event_id)
        else:
            await query.edit_message_text("ğŸš« Ø¸Ø±ÙÛŒØª Ù¾Ø± Ø´Ø¯Ù‡ ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯Ù‡.")
            await notify_user(context, user_id, False, event_id)
    elif action == "reject":
        await query.edit_message_text(f"âŒ {user_data['name']} Ø±Ø¯ Ø´Ø¯.")
        await notify_user(context, user_id, False, event_id)


def check_capacity_limit(event_id, user_data):
    """Ø¨Ø±Ø±Ø³ÛŒ Ø¸Ø±ÙÛŒØª Ú©Ù„ÛŒ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¬Ù†Ø³ÛŒØª"""
    roster = ROSTER.get(event_id, {})
    if len(roster) >= EVENT_CAPACITY:
        return False

    if user_data["gender"] == "Ù…Ø±Ø¯":
        male_count = sum(1 for u in roster.values() if u["gender"] == "Ù…Ø±Ø¯")
        if male_count >= MALE_LIMIT_PER_EVENT:
            return False

    return True


def get_event_name(event_id):
    for e in EVENTS:
        if str(e["id"]) == str(event_id):
            return e["name"]
    return "Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù†Ø§Ù…Ø´Ø®Øµ"


async def notify_user(context, user_id, approved, event_id):
    """Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾Ø³ Ø§Ø² ØªØµÙ…ÛŒÙ… Ø§Ø¯Ù…ÛŒÙ†"""
    if approved:
        msg = f"ğŸ‰ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…Øª Ø¯Ø± {get_event_name(event_id)} ØªØ£ÛŒÛŒØ¯ Ø´Ø¯! Ù…Ù†ØªØ¸Ø±Øª Ù‡Ø³ØªÛŒÙ… ğŸ™Œ"
    else:
        msg = f"Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± {get_event_name(event_id)} ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯ÛŒ ğŸ˜”"
    try:
        await context.bot.send_message(chat_id=user_id, text=msg)
    except Exception as e:
        logger.warning(f"Failed to notify user {user_id}: {e}")
# ======================
# Ø¨Ø®Ø´ Ø³ÙˆÙ…: feedback, auto-approve, ÙˆØ¨Ù‡ÙˆÚ© Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
# ======================

# Ù…ØªÙ† Ù…Ø¹Ø±ÙÛŒ Ú©Ø§ÙÙ‡ (Ø§Ú¯Ø± Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
CAFE_INTRO_TEXT = f"Ø§Ø³Ù… Ùˆ Ø¢Ø¯Ø±Ø³ Ú©Ø§ÙÙ‡ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡â€ŒØª Ø±Ùˆ Ø¨Ø±Ø§ÛŒ @{CAFE_INTRO_USERNAME} Ø¨ÙØ±Ø³Øª"

# ---------- Feedback (Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø± Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯) ----------
async def handle_feedback_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ feedback Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ â€” Ø­Ø§Ù„Øª Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯."""
    q = update.callback_query
    await q.answer()
    # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…Ù†Ùˆ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§
    try:
        await q.edit_message_text(
            "Ù…Ø±Ø³ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø¨Ø¯ÛŒ! âœï¸\n\n"
            "Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… ÛŒØ§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Ø¨ÙØ±Ø³Øª. Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ØŒ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡."
        )
    except Exception:
        # Ø§Ú¯Ø± Ø§Ø¯ÛŒØª Ù¾ÛŒØ§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ÙÙ‚Ø· ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
        await q.message.reply_text(
            "Ù…Ø±Ø³ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø¨Ø¯ÛŒ! âœï¸\n\n"
            "Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… ÛŒØ§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Ø¨ÙØ±Ø³Øª. Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ØŒ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡."
        )
    # Ø³Øª Ú©Ø±Ø¯Ù† Ù¾Ø±Ú†Ù… Ø¯Ø± user_data ØªØ§ Ù¾ÛŒØ§Ù… Ø¨Ø¹Ø¯ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯
    context.user_data["awaiting_feedback"] = True


async def process_incoming_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    Ù‡Ù†Ø¯Ù„Ø± Ù…ØªÙ†ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ú©Ù‡ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ù‡Ù… Ø¨Ø±Ø§ÛŒ feedback Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø®Ø§Øµ callbackÙ‡Ø§ Ø«Ø¨Øª Ø´ÙˆØ¯.
    """
    # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ø³ØªØŒ Ù…Ø³ÛŒØ± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†
    if context.user_data.get("register_step"):
        return await handle_registration_steps(update, context)

    # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„Øª feedback Ù‡Ø³ØªØŒ Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙØ±Ø³Øª
    if context.user_data.get("awaiting_feedback"):
        try:
            user = update.effective_user
            header = (
                f"ğŸ’¬ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± ChillChat:\n"
                f"ğŸ‘¤ Ù†Ø§Ù…: {user.full_name}\n"
                + (f"ğŸ†” @{user.username}\n" if user.username else "ğŸ†” â€”\n")
            )
            # Ø§Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø§Ø¯Ù…ÛŒÙ† (DATA_CENTER_CHAT_ID)
            if DATA_CENTER_CHAT_ID:
                await context.bot.send_message(chat_id=DATA_CENTER_CHAT_ID, text=header)
                # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ù¾ÛŒØ§Ù…Ø› Ø§Ú¯Ø± Ù†Ø´Ø¯ØŒ Ú©Ù¾ÛŒ Ú©Ù†
                try:
                    await context.bot.forward_message(
                        chat_id=DATA_CENTER_CHAT_ID,
                        from_chat_id=update.effective_chat.id,
                        message_id=update.message.message_id
                    )
                except Exception:
                    await context.bot.copy_message(
                        chat_id=DATA_CENTER_CHAT_ID,
                        from_chat_id=update.effective_chat.id,
                        message_id=update.message.message_id
                    )
            # Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
            await update.message.reply_text("Ù…Ù…Ù†ÙˆÙ† Ø§Ø² Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Øª ğŸ’› Ù¾ÛŒØ§Ù… ØªÙˆ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… ChillChat Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.", reply_markup=None)
        except Exception as e:
            logger.exception("Error while processing feedback message: %s", e)
            try:
                await update.message.reply_text("Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ â€” Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.")
            except:
                pass
        finally:
            # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª feedback
            context.user_data.pop("awaiting_feedback", None)
        return

    # Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø§Ú¯Ø± Ù†Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ù‡ feedback â€” Ù¾ÛŒØ§Ù… Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ± ÛŒØ§ Ù…Ù†Ùˆ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    await render_home(update, context)


# ---------- Auto-approve (ØªØ§ÛŒÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² Ø²Ù…Ø§Ù† Ù…Ø´Ø®Øµ) ----------
async def delayed_auto_approve(application, event_id: str, user_id: int, delay_hours: int = AUTO_APPROVE_HOURS):
    """
    Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ù…Ø´Ø®Øµ Ø§Ù‚Ø¯Ø§Ù…ÛŒ Ù†Ú©Ø±Ø¯ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ØªÙˆØ³Ø· send_to_admin Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø§Ø² PENDING Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    try:
        await asyncio.sleep(delay_hours * 3600)
    except asyncio.CancelledError:
        return

    # Ú†Ú© Ú©Ù† Ú©Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù†ÙˆØ² Ø¯Ø± PENDING Ù‡Ø³Øª
    pending_for_event = PENDING.get(event_id, {})
    info = pending_for_event.get(user_id)
    if not info:
        return  # Ù‚Ø¨Ù„Ø§Ù‹ ØªØ£ÛŒÛŒØ¯/Ø±Ø¯ Ø´Ø¯Ù‡ ÛŒØ§ Ø­Ø°Ù Ø´Ø¯Ù‡

    # Ø¨Ø±Ø±Ø³ÛŒ Ø¸Ø±ÙÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²
    roster_for_event = ROSTER.get(event_id, {})
    if len(roster_for_event) >= EVENT_CAPACITY:
        # Ø¸Ø±ÙÛŒØª Ù¾Ø± Ø´Ø¯Ø› Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡ Ùˆ Ø­Ø°ÙØ´ Ú©Ù†
        try:
            await application.bot.send_message(chat_id=user_id, text="âŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØªÚ©Ù…ÛŒÙ„ Ø¸Ø±ÙÛŒØª Ù„ØºÙˆ Ø´Ø¯.")
        except Exception:
            pass
        # Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø§Ø¯Ù…ÛŒÙ† Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡
        try:
            admin_msg_id = info.get("admin_msg_id")
            if admin_msg_id and DATA_CENTER_CHAT_ID:
                await application.bot.delete_message(chat_id=DATA_CENTER_CHAT_ID, message_id=admin_msg_id)
        except Exception:
            pass
        PENDING[event_id].pop(user_id, None)
        return

    # Ø³Ù‚Ù Ø¢Ù‚Ø§ÛŒØ§Ù†
    if info.get("gender") and info.get("gender").lower() in ("Ù…Ø±Ø¯", "male") :
        male_count = sum(1 for u in roster_for_event.values() if u.get("gender") and u.get("gender").lower() in ("Ù…Ø±Ø¯", "male"))
        if male_count >= MALE_LIMIT_PER_EVENT:
            try:
                await application.bot.send_message(chat_id=user_id, text=MALE_CAPACITY_FULL_MSG)
            except Exception:
                pass
            try:
                admin_msg_id = info.get("admin_msg_id")
                if admin_msg_id and DATA_CENTER_CHAT_ID:
                    await application.bot.delete_message(chat_id=DATA_CENTER_CHAT_ID, message_id=admin_msg_id)
            except Exception:
                pass
            PENDING[event_id].pop(user_id, None)
            return

    # Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø®ÙˆØ¨Ù‡ â€” Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† Ø¨Ù‡ ROSTER Ùˆ Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡
    ROSTER.setdefault(event_id, {})[user_id] = info
    # Ø­Ø°Ù Ø§Ø² pending
    PENDING[event_id].pop(user_id, None)
    # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ù¾ÛŒÙ†â€ŒØ´Ø¯Ù‡ (Ø§Ú¯Ø± Ø¯Ø§Ø¯ÛŒâ€ŒØ³Ù†ØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ)
    try:
        await save_state_to_pinned(application)
    except Exception:
        pass

    # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    try:
        await application.bot.send_message(
            chat_id=user_id,
            text=f"ğŸ‰ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…Øª Ø¯Ø± {get_event_name(event_id)} Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ø´Ø¯! Ù…Ù†ØªØ¸Ø±Øª Ù‡Ø³ØªÛŒÙ… ğŸ™Œ"
        )
    except Exception:
        pass


# ---------- Ú©Ù…Ú©ÛŒ: Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù¾ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¯ÛŒØªØ§Ø³Ù†ØªØ± (Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡) ----------
async def save_state_to_pinned(application):
    """
    Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ù¾ÛŒÙ†â€ŒØ´Ø¯Ù‡ Ø¯Ø± DATA_CENTER_CHAT_ID.
    """
    if not DATA_CENTER_CHAT_ID:
        return
    text = "ğŸ“‹ Ù„ÛŒØ³Øª Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§:\n"
    for ev in EVENTS:
        ev_id = ev.get("id")
        roster_for_event = ROSTER.get(ev_id, {})
        text += f"\nğŸ—“ {ev.get('name','Ø±ÙˆÛŒØ¯Ø§Ø¯')} â€” {ev.get('when','â€”')} | {len(roster_for_event)} Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡\n"
        for uid, u in roster_for_event.items():
            uname = f"@{u.get('username')}" if u.get("username") else "â€”"
            phone = u.get("phone","â€”")
            text += f"  â€¢ {u.get('name','â€”')} | {uname} | {phone}\n"
    try:
        # Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ: ÙÙ‚Ø· Ø§Ø±Ø³Ø§Ù„ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ (Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù… Ù¾ÛŒÙ†â€ŒØ´Ø¯Ù‡ Ù¾ÛŒÚ†ÛŒØ¯Ù‡â€ŒØªØ± Ø§Ø³Øª)
        msg = await application.bot.send_message(chat_id=DATA_CENTER_CHAT_ID, text=text)
        try:
            await application.bot.pin_chat_message(chat_id=DATA_CENTER_CHAT_ID, message_id=msg.message_id, disable_notification=True)
        except Exception:
            pass
    except Exception as e:
        logger.warning("save_state_to_pinned failed: %s", e)


# ---------- Handler Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø±ÙÛŒ Ú©Ø§ÙÙ‡ ----------
async def handle_cafe_intro_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    try:
        await q.edit_message_text(CAFE_INTRO_TEXT)
    except Exception:
        await q.message.reply_text(CAFE_INTRO_TEXT)


# ---------- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Application Ùˆ FastAPI ÙˆØ¨Ù‡ÙˆÚ© ----------
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is not set in environment")

# Ø³Ø§Ø®Øª Application (Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ PTB Ø¬Ø¯ÛŒØ¯)
application = Application.builder().token(BOT_TOKEN).build()

# Ø«Ø¨Øª Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
application.add_handler(CommandHandler("start", start))

# Callback handlers
application.add_handler(CallbackQueryHandler(handle_register_callback, pattern=r"^register$"))
application.add_handler(CallbackQueryHandler(handle_feedback_callback, pattern=r"^feedback$"))
application.add_handler(CallbackQueryHandler(handle_cafe_intro_callback, pattern=r"^cafe_intro$"))
# Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§: pattern event_{id}
application.add_handler(CallbackQueryHandler(handle_event_selection, pattern=r"^event_"))
# Admin approve/reject
application.add_handler(CallbackQueryHandler(handle_admin_decision, pattern=r"^(approve_|reject_)"))

# Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù…ØªÙ†ÛŒ (Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… / feedback / Ø¹Ù…ÙˆÙ…ÛŒ)
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, process_incoming_text))

# ÙˆØ¨Ù‡ÙˆÚ© Ø¨Ø§ FastAPI
from contextlib import asynccontextmanager
from fastapi import FastAPI, Request

@asynccontextmanager
async def lifespan(app: FastAPI):
    # initialize application and set webhook (Ø§Ú¯Ø± WEBHOOK_URL Ø³Øª Ø´Ø¯Ù‡)
    await application.initialize()
    if WEBHOOK_URL:
        try:
            await application.bot.set_webhook(url=WEBHOOK_URL)
            logger.info("Webhook set to %s", WEBHOOK_URL)
        except Exception as e:
            logger.exception("Setting webhook failed: %s", e)
    await application.start()
    yield
    await application.stop()
    await application.shutdown()

app = FastAPI(lifespan=lifespan)

@app.post("/")
async def webhook_endpoint(request: Request):
    body = await request.json()
    update = Update.de_json(body, application.bot)
    await application.process_update(update)
    return {"status": "ok"}

@app.get("/")
async def root():
    return {"status": "ChillChat bot is running."}

# ---------- Ù†Ú©ØªÙ‡: Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ auto-approve Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† ----------
# Ø¯Ø± send_to_admin (Ø¯Ø± Ø¨Ø®Ø´ Û²) Ø¨Ù‡ØªØ± Ø§Ø³Øª task Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯:
#   task = application.create_task(delayed_auto_approve(application, event_id, user_id, delay_hours=AUTO_APPROVE_HOURS))
#   Ø³Ù¾Ø³ task Ø±Ø§ Ø¯Ø± PENDING[event_id][user_id]["task"] Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† ØªØ§ Ø¯Ø± ØµÙˆØ±Øª approve/reject Ù‚Ø§Ø¨Ù„ cancel Ø¨Ø§Ø´Ø¯.
#
# Ø§Ú¯Ø± Ø¯Ø± send_to_admin Ø§ÛŒÙ†Ú©Ø§Ø± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒØŒ Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ú©Ù‡ Ù‡Ù†Ú¯Ø§Ù… approve/reject Ø¢Ù† task Ø±Ø§ cancel Ù…ÛŒâ€ŒÚ©Ù†ÛŒ:
#   if info.get("task"): info["task"].cancel()
#
# (Ø§ÛŒÙ† Ù…ØªÙ† ØµØ±ÙØ§Ù‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø§Ø³ØªØ› Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ù…Ù† Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† send_to_admin Ø±Ø§ Ø¯Ø± Ø¨Ø®Ø´ Û² Ø¨Ø±ÙˆØ² Ú©Ù†Ù… ØªØ§ task Ø¨Ø³Ø§Ø²Ø¯ØŒ Ø§Ø¹Ù„Ø§Ù… Ú©Ù†.)
